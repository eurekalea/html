<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ç™»å…¥ç¤ºç¯„ï¼šSession é‡æ”¾</title>
  <style>
    body{font-family:"å¾®è»Ÿæ­£é»‘é«”",system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:#0b1220;color:#e8eefc;margin:0;padding:20px}
    h1{margin:0 0 10px;font-size:18px}
    .wrap{display:grid;grid-template-columns:1fr 1fr;gap:14px;max-width:980px;margin:0 auto}
    .card{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:16px;box-shadow:0 12px 40px rgba(0,0,0,.35)}
    label{display:block;font-size:13px;margin:10px 0 6px;color:rgba(232,238,252,.8)}
    input,textarea{width:100%;box-sizing:border-box;border-radius:12px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.25);color:#e8eefc;padding:12px;font-size:14px;outline:none}
    input:focus,textarea:focus{border-color:rgba(120,170,255,.8);box-shadow:0 0 0 4px rgba(120,170,255,.18)}
    .row{position:relative}
    .eye{position:absolute;right:10px;top:50%;transform:translateY(-50%);border:0;background:transparent;color:rgba(232,238,252,.85);cursor:pointer;padding:6px 8px;border-radius:10px}
    .eye:hover{background:rgba(255,255,255,.08)}
    .btn{border:0;border-radius:12px;padding:11px 14px;font-weight:800;cursor:pointer;background:linear-gradient(90deg,#6aa6ff,#8b7bff);color:#0b1220}
    .btn.full{width:100%}
    .btn.ghost{background:rgba(255,255,255,.08);color:rgba(232,238,252,.9);border:1px solid rgba(255,255,255,.14)}
    .msg{min-height:18px;margin-top:10px;font-size:13px;color:#ffb3b3}
    .ok{margin-top:10px;padding:12px;border-radius:12px;background:rgba(0,255,140,.08);border:1px solid rgba(0,255,140,.25);color:rgba(232,238,252,.92)}
    code{background:rgba(0,0,0,.35);padding:2px 6px;border-radius:8px;border:1px solid rgba(255,255,255,.12)}
    .hint{margin-top:10px;font-size:12px;color:rgba(232,238,252,.65);line-height:1.45}
    .warn{margin-top:10px;padding:10px;border-radius:12px;background:rgba(255,180,0,.08);border:1px solid rgba(255,180,0,.25);color:rgba(232,238,252,.9);font-size:12px;line-height:1.45}
    @media (max-width: 860px){.wrap{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div style="max-width:980px;margin:0 auto 12px;">
    <h1>æ•™å­¸ç¤ºç¯„ï¼šæ‹¿åˆ° <code>session token</code> å°±å¯èƒ½ã€Œé‡æ”¾ç™»å…¥ã€ï¼ˆä¸ç¤ºç¯„ç«Šå–æ‰‹æ³•ï¼‰</h1>
    <div class="hint">
      è‹¥ä½ æ˜¯ç›´æ¥é›™æ“Šé–‹æª”ï¼ˆ<code>file://</code>ï¼‰ï¼Œå¾ˆå¤šç€è¦½å™¨æœƒè®“ Cookie å¤±æ•ˆï¼›æœ¬ç‰ˆæœ¬æœƒè‡ªå‹•æ”¹ç”¨ localStorage è®“ç¤ºç¯„ä»å¯é€²è¡Œã€‚
    </div>
  </div>

  <div class="wrap">
    <!-- ä½¿ç”¨è€…ç«¯ -->
    <div class="card">
      <h2 style="margin:0 0 6px;font-size:16px;">ğŸ§‘â€ğŸ’» ä½¿ç”¨è€…ï¼šæ­£å¸¸ç™»å…¥</h2>
      <div class="hint">å¸³è™Ÿé è¨­ï¼š<code>student</code>ï½œå¯†ç¢¼é è¨­ï¼š<code>thisistest</code></div>

      <div class="warn" id="envWarn" style="display:none;"></div>

      <label for="u">å¸³è™Ÿ</label>
      <input id="u" autocomplete="username" value="student"/>

      <label for="p">å¯†ç¢¼</label>
      <div class="row">
        <input id="p" type="password" autocomplete="current-password" value="thisistest"/>
        <button class="eye" id="toggle" type="button" aria-label="åˆ‡æ›é¡¯ç¤ºå¯†ç¢¼">ğŸ‘ï¸</button>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px;">
        <button class="btn full" id="login" type="button">Log in</button>
        <button class="btn full ghost" id="logout" type="button">ç™»å‡º</button>
      </div>

      <div class="msg" id="userMsg"></div>

      <div class="ok" id="userOK" style="display:none;">
        âœ… æˆåŠŸç™»å…¥ç³»çµ±ï¼ˆä½¿ç”¨è€…ç«¯ï¼‰
        <div class="hint" style="margin-top:6px;">
          session tokenï¼š<code id="tokenShow">ï¼ˆå°šæœªç™»å…¥ï¼‰</code><br/>
          æŒ‰ä¸‹æŒ‰éˆ•è¤‡è£½ tokenï¼Œè²¼åˆ°å³é‚Šåšã€Œé‡æ”¾ç™»å…¥ã€ç¤ºç¯„ã€‚
        </div>
        <button class="btn ghost" id="copyToken" type="button" style="margin-top:10px;">è¤‡è£½ tokenï¼ˆæ¨¡æ“¬å¤–æµï¼‰</button>
      </div>
    </div>

    <!-- æ”»æ“Šè€…ç«¯ -->
    <div class="card">
      <h2 style="margin:0 0 6px;font-size:16px;">ğŸ•µï¸ æ”»æ“Šè€…ï¼šé‡æ”¾é€šè¡Œè­‰</h2>
      <div class="hint">
        é€™è£¡åªç¤ºç¯„ã€Œå¦‚æœ token å¤–æµæœƒæ€æ¨£ã€ï¼Œä¸ç¤ºç¯„ã€Œæ€éº¼å·ã€ã€‚
      </div>

      <label for="stolen">æ‹¿åˆ°çš„ tokenï¼ˆè²¼ä¸Šï¼‰</label>
      <textarea id="stolen" rows="4" placeholder="æŠŠå·¦é‚Šè¤‡è£½çš„ token è²¼åœ¨é€™è£¡..."></textarea>

      <button class="btn full" id="replay" type="button" style="margin-top:12px;">ä½¿ç”¨ token ç™»å…¥ï¼ˆé‡æ”¾ï¼‰</button>
      <div class="msg" id="attMsg"></div>

      <div class="ok" id="attOK" style="display:none;">
        âœ… æˆåŠŸç™»å…¥ç³»çµ±ï¼ˆæ”»æ“Šè€…ç«¯ï¼‰<br/>
        <span class="hint">å¯†ç¢¼æ²’è¢«ç ´è§£ï¼Œä½†é€šè¡Œè­‰è¢«é‡æ”¾äº†ã€‚</span>
      </div>
    </div>
  </div>

  <script>
    const VALID_USER = "student";
    const VALID_PASS = "thisistest";

    const u = document.getElementById("u");
    const p = document.getElementById("p");
    const userMsg = document.getElementById("userMsg");
    const userOK = document.getElementById("userOK");
    const tokenShow = document.getElementById("tokenShow");
    const envWarn = document.getElementById("envWarn");

    const stolen = document.getElementById("stolen");
    const attMsg = document.getElementById("attMsg");
    const attOK = document.getElementById("attOK");

    document.getElementById("toggle").addEventListener("click", () => {
      p.type = (p.type === "password") ? "text" : "password";
    });

    // ===== Cookie å·¥å…·ï¼ˆå¯èƒ½åœ¨ file:// å¤±æ•ˆï¼‰=====
    function setCookie(name, value, days) {
      const maxAge = days * 24 * 60 * 60;
      // Secure åªåœ¨ https æ‰èƒ½ç”¨ï¼›é€™è£¡ä¸åŠ ï¼Œé¿å…æ•™å®¤ localhost/http å¤±æ•ˆ
      document.cookie = `${encodeURIComponent(name)}=${encodeURIComponent(value)}; Max-Age=${maxAge}; Path=/; SameSite=Lax`;
    }
    function getCookie(name) {
      if (!document.cookie) return null;
      const parts = document.cookie.split(";").map(s => s.trim());
      for (const c of parts) {
        const eq = c.indexOf("=");
        const k = eq >= 0 ? c.slice(0, eq) : c;
        const v = eq >= 0 ? c.slice(eq + 1) : "";
        if (decodeURIComponent(k) === name) return decodeURIComponent(v);
      }
      return null;
    }
    function delCookie(name) {
      document.cookie = `${encodeURIComponent(name)}=; Max-Age=0; Path=/; SameSite=Lax`;
    }

    // ===== å„²å­˜å±¤ï¼šCookie å„ªå…ˆï¼Œå¤±æ•—å°± localStorage =====
    const KEY = "demo_session_token";
    function cookieWorks() {
      try {
        const probe = "cookie_probe_" + Math.random().toString(16).slice(2);
        setCookie(probe, "1", 1);
        const ok = getCookie(probe) === "1";
        delCookie(probe);
        return ok;
      } catch {
        return false;
      }
    }
    const CAN_COOKIE = cookieWorks();

    if (!CAN_COOKIE) {
      envWarn.style.display = "block";
      envWarn.innerHTML =
        `åµæ¸¬åˆ°æ­¤ç’°å¢ƒ Cookie å¯èƒ½ä¸å¯ç”¨ï¼ˆå¸¸è¦‹æ–¼ <code>file://</code> ç›´æ¥é–‹æª”ï¼‰ã€‚<br/>
         æœ¬ç¤ºç¯„æœƒæ”¹ç”¨ <code>localStorage</code> ä¿å­˜ tokenï¼Œæ•ˆæœä¸€æ¨£ï¼štoken å¤–æµ â†’ å¯è¢«é‡æ”¾ã€‚<br/>
         è‹¥è¦çœŸçš„ç”¨ Cookie ç¤ºç¯„ï¼Œå»ºè­°ç”¨ VS Code Live Server / localhost é–‹å•Ÿã€‚`;
    }

    function setToken(token) {
      // å…©è€…éƒ½å¯«ï¼šèƒ½ç”¨ Cookie å°±ç”¨ Cookieï¼›localStorage è®“ file:// ä¹Ÿèƒ½è·‘
      localStorage.setItem(KEY, token);
      if (CAN_COOKIE) setCookie(KEY, token, 1);
    }
    function getToken() {
      // å…ˆè®€ Cookieï¼ˆè‹¥å¯ç”¨ï¼‰ï¼Œå¦å‰‡è®€ localStorage
      if (CAN_COOKIE) {
        const t = getCookie(KEY);
        if (t) return t;
      }
      return localStorage.getItem(KEY);
    }
    function clearToken() {
      localStorage.removeItem(KEY);
      if (CAN_COOKIE) delCookie(KEY);
    }

    function randomToken() {
      const bytes = new Uint8Array(16);
      crypto.getRandomValues(bytes);
      return Array.from(bytes).map(b => b.toString(16).padStart(2, "0")).join("");
    }

    document.getElementById("login").addEventListener("click", () => {
      userMsg.textContent = "";
      attMsg.textContent = "";
      attOK.style.display = "none";

      if (u.value.trim() === VALID_USER && p.value === VALID_PASS) {
        const t = randomToken();
        setToken(t);
        userOK.style.display = "block";
        tokenShow.textContent = t;
      } else {
        userOK.style.display = "none";
        tokenShow.textContent = "ï¼ˆå°šæœªç™»å…¥ï¼‰";
        userMsg.textContent = "å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤ï¼Œç„¡æ³•ç™»å…¥";
      }
    });

    document.getElementById("logout").addEventListener("click", () => {
      clearToken();
      userOK.style.display = "none";
      tokenShow.textContent = "ï¼ˆå°šæœªç™»å…¥ï¼‰";
      userMsg.textContent = "";
      attMsg.textContent = "";
      attOK.style.display = "none";
      stolen.value = "";
      p.type = "password";
    });

    document.getElementById("copyToken").addEventListener("click", async () => {
      const t = getToken();
      if (!t) return;
      try {
        await navigator.clipboard.writeText(t);
        userMsg.style.color = "rgba(232,238,252,.75)";
        userMsg.textContent = "å·²è¤‡è£½ tokenï¼ˆæ¨¡æ“¬å¤–æµï¼‰â€”æŠŠå®ƒè²¼åˆ°å³é‚Šã€‚";
        setTimeout(() => { userMsg.textContent = ""; }, 1500);
      } catch {
        userMsg.textContent = "ç€è¦½å™¨ä¸å…è¨±å‰ªè²¼ç°¿å­˜å–ï¼Œè«‹æ‰‹å‹•é¸å–ä¸Šæ–¹ token è¤‡è£½ã€‚";
      }
    });

    document.getElementById("replay").addEventListener("click", () => {
      attMsg.textContent = "";
      attOK.style.display = "none";

      const real = getToken();
      const given = stolen.value.trim();

      if (!given) {
        attMsg.textContent = "è«‹å…ˆè²¼ä¸Šæ‹¿åˆ°çš„ tokenã€‚";
        return;
      }
      if (real && given === real) {
        attOK.style.display = "block";
      } else {
        attMsg.textContent = "token ç„¡æ•ˆæˆ–å·²å¤±æ•ˆï¼ˆç¤ºç¯„ï¼šé€šè¡Œè­‰æœƒéæœŸ/å¯æ’¤éŠ·/ä¸åŒ¹é…ï¼‰ã€‚";
      }
    });

    // é‡æ–°æ•´ç†å¾Œï¼šè‹¥ token é‚„åœ¨ï¼Œå°±é¡¯ç¤ºå·²ç™»å…¥ç‹€æ…‹
    const existing = getToken();
    if (existing) {
      userOK.style.display = "block";
      tokenShow.textContent = existing;
    }
  </script>
</body>
</html>
