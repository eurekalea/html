<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç­ç´šåˆ†çµ„åº§ä½ç³»çµ±ï¼ˆå°é½Šå„ªåŒ–ç‰ˆï¼‰</title>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <style>
    :root {
      --primary-color: #4a90e2;
      --bg-color: #f4f7f9;
      --panel-bg: #ffffff;
      --desk-color: #333333;
      --border-radius: 8px;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    body {
      font-family: "Microsoft JhengHei", "Noto Sans TC", sans-serif;
      background-color: var(--bg-color);
      margin: 0;
      padding: 20px;
      display: flex;
      height: 100vh;
      box-sizing: border-box;
      gap: 20px;
      overflow: hidden;
    }

    /* --- å·¦å´åŠŸèƒ½å€ --- */
    .sidebar {
      width: 200px;
      background: var(--panel-bg);
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      gap: 10px;
      flex-shrink: 0;
    }

    .sidebar h3 {
      margin: 0 0 10px 0;
      font-size: 18px;
      color: #555;
      text-align: center;
    }

    button {
      padding: 10px;
      border: none;
      background-color: var(--primary-color);
      color: white;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s;
      font-size: 14px;
    }

    button:hover {
      background-color: #357abd;
    }

    button.secondary {
      background-color: #6c757d;
    }

    button.secondary:hover {
      background-color: #5a6268;
    }

    .class-input-area {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #eee;
    }
    
    .class-input-area label {
      display: block;
      margin-bottom: 5px;
      font-size: 14px;
      color: #666;
    }
    
    .class-input-area input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }

    /* --- ä¸­é–“ä¸»è¦é¡¯ç¤ºå€ --- */
    .main-container {
      flex: 1;
      background: #e9eff5;
      border-radius: var(--border-radius);
      overflow: auto;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 20px;
      border: 2px dashed #ccc;
    }

    #exportArea {
      background: white;
      padding: 40px;
      border-radius: 4px;
      box-shadow: 0 0 15px rgba(0,0,0,0.05);
      min-width: 800px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    #classTitle {
      font-size: 48px;
      font-weight: bold;
      margin-bottom: 20px;
      background: linear-gradient(45deg, #005bea, #00c6fb);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      border: 2px solid #005bea;
      padding: 10px 30px;
      border-radius: 50px;
      min-width: 300px;
      text-align: center;
    }

    /* èª¿æ•´å¾Œçš„è€å¸«æ¡Œæ¨£å¼ 
       width: 100% è®“å®ƒè‡ªå‹•å¡«æ»¿çˆ¶å®¹å™¨ (ä¹Ÿå°±æ˜¯å·¦é‚Šé‚£å€‹ table-block)
    */
    .teacher-desk {
      width: 100%; 
      height: 50px;
      background: #ddd;
      border: 2px solid #999;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: #555;
      border-radius: 4px;
      letter-spacing: 2px;
      box-sizing: border-box; /* ç¢ºä¿é‚Šæ¡†ç®—åœ¨å¯¬åº¦å…§ */
    }

    /* å³å´éš±å½¢ä½”ä½ï¼Œç¢ºä¿å·¦å³åº§ä½é«˜åº¦å°é½Š */
    .teacher-desk-spacer {
      width: 100%;
      height: 50px; /* èˆ‡è€å¸«æ¡ŒåŒé«˜ */
      visibility: hidden; /* éš±è—ä½†ä½”ä½ */
    }

    .seat-area {
      display: flex;
      gap: 80px; /* å¢åŠ èµ°é“å¯¬åº¦ï¼Œè®“åˆ†é–‹æ„Ÿæ›´æ˜é¡¯ */
    }

    .table-block {
      display: flex;
      flex-direction: column;
      gap: 30px;
      /* è®“ block å¯¬åº¦ç”±å…§å®¹ (252px) æ±ºå®šï¼Œè€å¸«æ¡Œå°±æœƒè·Ÿè‘—é€™å€‹å¯¬åº¦ */
      align-items: stretch; 
    }

    .desk-row {
      display: flex;
      align-items: stretch;
    }

    .group {
      width: 110px;
      display: flex;
      flex-direction: column;
    }

    .group h4 {
      text-align: center;
      margin: 0 0 8px 0;
      height: 24px;
      color: #555;
      font-size: 14px;
    }

    .seat-column {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .seat {
      height: 40px;
      background-color: #fff;
      border: 2px dashed #ccc;
      border-radius: 6px;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: background 0.2s;
    }

    .seat:hover {
      background-color: #f9f9f9;
    }

    .desk {
      width: 12px;
      background: var(--desk-color);
      margin: 0 10px;
      border-radius: 2px;
      margin-top: 32px; 
    }

    /* --- å³å´æ“ä½œå€ --- */
    .right-panel {
      width: 220px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      flex-shrink: 0;
    }

    .input-box {
      background: var(--panel-bg);
      padding: 15px;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .input-box h4 {
      margin: 0;
      color: #333;
    }

    textarea {
      width: 100%;
      box-sizing: border-box;
      resize: vertical;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    .unassigned-container {
      flex: 1;
      background: var(--panel-bg);
      padding: 15px;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .unassigned-container h4 {
      margin: 0 0 10px 0;
      color: #333;
    }

    .unassigned-list {
      flex: 1;
      overflow-y: auto;
      border: 1px solid #eee;
      padding: 5px;
      border-radius: 4px;
      background: #fafafa;
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      align-content: flex-start;
    }

    .number {
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      background: #fff;
      border: 1px solid #aaa;
      border-radius: 4px;
      cursor: grab;
      font-weight: bold;
      font-size: 16px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      user-select: none;
    }
    
    .number:active {
      cursor: grabbing;
      background: #eef;
    }

    .unassigned-list .number {
      width: 40px;
      height: 40px;
      font-size: 14px;
    }

    @media (max-width: 1024px) {
      body { flex-direction: column; overflow: auto; height: auto; }
      .sidebar, .right-panel { width: 100%; }
      .main-container { min-height: 500px; }
    }
  </style>
</head>
<body>

  <div class="sidebar">
    <h3>æ§åˆ¶é¢æ¿</h3>
    <button onclick="autoAssign()">ğŸª„ ä¸€éµäº‚æ•¸æ’å®Œ</button>
    <button class="secondary" onclick="clearSeats()">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰åº§ä½</button>
    
    <div style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 10px;">
      <h3>åŒ¯å‡ºåŠŸèƒ½</h3>
      <button onclick="exportJPG()">ğŸ“· ä¸‹è¼‰åœ–ç‰‡ (JPG)</button>
      <button class="secondary" onclick="exportCSV()">ğŸ“Š åŒ¯å‡º Excel (CSV)</button>
    </div>

    <div class="class-input-area">
      <label for="classInput">æ›´æ”¹ç­ç´šåç¨±ï¼š</label>
      <input id="classInput" type="text" value="ä¸‰å¹´2ç­" oninput="updateClassTitle()" />
    </div>
  </div>

  <div class="main-container">
    <div id="exportArea">
      <div id="classTitle">ä¸‰å¹´2ç­</div>
      
      <div class="seat-area" id="seatArea">
        
        <div class="table-block">
          <div class="teacher-desk">è¬›å° / è€å¸«æ¡Œ</div>
          
          <div class="desk-row">
            <div class="group" id="g1"></div>
            <div class="desk"></div>
            <div class="group" id="g3"></div>
          </div>
          <div class="desk-row">
            <div class="group" id="g2"></div>
            <div class="desk"></div>
            <div class="group" id="g4"></div>
          </div>
        </div>

        <div class="table-block">
          <div class="teacher-desk-spacer"></div>

          <div class="desk-row">
            <div class="group" id="g5"></div>
            <div class="desk"></div>
            <div class="group" id="g7"></div>
          </div>
          <div class="desk-row">
            <div class="group" id="g6"></div>
            <div class="desk"></div>
            <div class="group" id="g8"></div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <div class="right-panel">
    <div class="input-box">
      <h4>1. è¼¸å…¥åº§è™Ÿ</h4>
      <span style="font-size:12px; color:#888;">(è«‹ç”¨é€—è™Ÿæˆ–æ›è¡Œåˆ†éš”)</span>
      <textarea id="inputNumbers" rows="5" placeholder="ä¾‹å¦‚: 1, 2, 3..."></textarea>
      <button onclick="generateNumbers()">â¬‡ï¸ ç”¢ç”Ÿåº§è™Ÿå¡</button>
    </div>

    <div class="unassigned-container">
      <h4>2. æœªå®‰æ’åº§ä½</h4>
      <div class="unassigned-list" id="unassigned" ondragover="allowDrop(event)" ondrop="drop(event)"></div>
    </div>
  </div>

  <script>
    const seatMap = { g1: 4, g2: 4, g3: 4, g4: 4, g5: 4, g6: 3, g7: 4, g8: 3 };

    document.addEventListener("DOMContentLoaded", () => {
      Object.keys(seatMap).forEach(id => buildGroup(id, seatMap[id]));
      document.getElementById("inputNumbers").value = Array.from({length:30}, (_, i) => i + 1).join(", ");
      generateNumbers();
      updateClassTitle();
    });

    function updateClassTitle() {
      const val = document.getElementById("classInput").value.trim();
      document.getElementById("classTitle").textContent = val || "ç­ç´šåç¨±";
    }

    function buildGroup(id, seatCount) {
      const g = document.getElementById(id);
      const title = document.createElement("h4");
      title.textContent = "ç¬¬" + id.replace("g", "") + "çµ„";
      g.appendChild(title);

      const col = document.createElement("div");
      col.className = "seat-column";
      
      for (let i = 0; i < seatCount; i++) {
        const seat = document.createElement("div");
        seat.className = "seat";
        seat.ondragover = allowDrop;
        seat.ondrop = drop;
        col.appendChild(seat);
      }
      g.appendChild(col);
    }

    function allowDrop(ev) { ev.preventDefault(); }
    function drag(ev) { ev.dataTransfer.setData("text", ev.target.id); }
    function drop(ev) {
      ev.preventDefault();
      const dataId = ev.dataTransfer.getData("text");
      const el = document.getElementById(dataId);
      let target = ev.target;
      if (target.classList.contains("number")) { target = target.parentElement; }
      if (target.id === "unassigned") {
        target.appendChild(el);
        return;
      }
      if (target.classList.contains("seat") && target.children.length === 0) {
        target.appendChild(el);
      }
    }

    function generateNumbers() {
      const raw = document.getElementById("inputNumbers").value;
      const nums = raw.split(/[\n,ï¼Œ\s]+/).map(x => x.trim()).filter(x => x);
      clearSeats(); 
      const area = document.getElementById("unassigned");
      area.innerHTML = "";
      nums.forEach(n => {
        const d = document.createElement("div");
        d.className = "number";
        d.id = "num_" + n;
        d.textContent = n;
        d.draggable = true;
        d.ondragstart = drag;
        area.appendChild(d);
      });
    }

    function clearSeats() {
      const area = document.getElementById("unassigned");
      document.querySelectorAll(".group .number").forEach(numDiv => {
        area.appendChild(numDiv);
      });
    }

    function autoAssign() {
      let nums = Array.from(document.querySelectorAll("#unassigned .number"));
      if (!nums.length) {
        alert("å¾…å‘½å€æ²’æœ‰å­¸ç”Ÿï¼è«‹å…ˆç”¢ç”Ÿåº§è™Ÿï¼Œæˆ–å°‡åº§ä½æ¸…ç©ºã€‚");
        return;
      }
      nums.sort(() => Math.random() - 0.5);

      let numIndex = 0;

      function getEmptySeats(groupId) {
        const seats = Array.from(document.querySelectorAll("#g" + groupId + " .seat"));
        return seats.filter(s => s.children.length === 0);
      }
      
      function getOccupiedCount(groupId) {
        const seats = Array.from(document.querySelectorAll("#g" + groupId + " .seat"));
        return seats.filter(s => s.children.length > 0).length;
      }

      // éšæ®µä¸€ï¼š1-7çµ„å…ˆè£œæ»¿3äºº
      for (let i = 1; i <= 7; i++) {
        let currentCount = getOccupiedCount(i);
        let emptySeats = getEmptySeats(i);
        while (currentCount < 3 && emptySeats.length > 0 && numIndex < nums.length) {
          emptySeats[0].appendChild(nums[numIndex++]);
          emptySeats.shift();
          currentCount++;
        }
      }

      // éšæ®µäºŒï¼šç¬¬8çµ„è£œæ»¿3äºº
      if (numIndex < nums.length) {
        let i = 8;
        let currentCount = getOccupiedCount(i);
        let emptySeats = getEmptySeats(i);
        while (currentCount < 3 && emptySeats.length > 0 && numIndex < nums.length) {
          emptySeats[0].appendChild(nums[numIndex++]);
          emptySeats.shift();
          currentCount++;
        }
      }

      // éšæ®µä¸‰ï¼šå¡«æ»¿å‰©é¤˜ç©ºä½
      if (numIndex < nums.length) {
        let allRemainingSeats = [];
        for (let i = 1; i <= 8; i++) {
          allRemainingSeats = allRemainingSeats.concat(getEmptySeats(i));
        }
        for (let seat of allRemainingSeats) {
          if (numIndex >= nums.length) break;
          seat.appendChild(nums[numIndex++]);
        }
      }
    }

    function exportJPG() {
      const area = document.getElementById("exportArea");
      const originalBg = area.style.background;
      area.style.background = "#ffffff";
      html2canvas(area, { scale: 2 }).then(canvas => {
        const a = document.createElement("a");
        a.href = canvas.toDataURL("image/jpeg", 0.9);
        a.download = document.getElementById("classTitle").textContent + "_åº§ä½è¡¨.jpg";
        a.click();
        area.style.background = originalBg;
      }).catch(err => {
        alert("æˆªåœ–å¤±æ•—ï¼Œè«‹ç¢ºèªç€è¦½å™¨æ”¯æ´ã€‚");
      });
    }

    function exportCSV() {
      let csv = "\uFEFFç»„åˆ¥,åº§ä½1,åº§ä½2,åº§ä½3,åº§ä½4\n";
      for (let i = 1; i <= 8; i++) {
        const seats = Array.from(document.querySelectorAll("#g" + i + " .seat"))
          .map(s => s.children.length ? s.children[0].textContent : "");
        csv += "ç¬¬" + i + "çµ„," + seats.join(",") + "\n";
      }
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = document.getElementById("classTitle").textContent + "_åº§ä½è¡¨.csv";
      a.click();
    }
  </script>
</body>
</html>